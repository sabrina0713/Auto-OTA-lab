<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"></meta>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datejs/1.0/date.min.js"></script>

<link rel="stylesheet" type="text/css" href="/openPoints/tabs.css">
<link rel="stylesheet" type="text/css" href="/openPoints/styles.css">

<script type="text/javascript">

	// Variables for passing blockchain REST calls from NODE JS
	var hostName 		= "#HOSTNAME#";
	var localUrlStub 	= "http://" + hostName;
  
	// Open the tabs of the Open Points Website
	function openTab(evt, tabName) {
		
		// Declare all variables
		var i, tabcontent, tablinks;

		// Get all elements with class="tabcontent" and display Configuration as deafult
		tabcontent = document.getElementsByClassName("tabcontent");
		for (i = 0; i < tabcontent.length; i++) {
			tabcontent[i].style.display = "none";
		}

		// Get all elements with class="tablinks" and remove the class "active"
		tablinks = document.getElementsByClassName("tablinks");
		for (i = 0; i < tablinks.length; i++) {
			tablinks[i].className = tablinks[i].className
					.replace("active", "");
		}

		// Show the current tab, and add an "active" class to the link that opened the tab
		document.getElementById(tabName).style.display = "block";
		document.getElementById(tabName).click();
		evt.currentTarget.className += " active";

	}	
	// Make REST calls to the blockchain using the NODE JS REST API
	function blockchainRestApi(url, parsingFunction) {	
		var xmlhttp = null;
		if (window.XMLHttpRequest) {
			xmlhttp = new XMLHttpRequest();
			if (typeof xmlhttp.overrideMimeType != 'undefined') {
				xmlhttp.overrideMimeType('text/xml');
			}
		} else if (window.ActiveXObject) {
			xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
		} else {
			alert('Perhaps your browser does not support xmlhttprequests?');
		}

		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
				parsingFunction(xmlhttp.responseText);
			} else {
				// wait for the call to complete
			}
		};

		xmlhttp.open('GET', url, true);
		xmlhttp.send(null);

	}

	// Parse smart contracts from Blockchain service into HTML table
	function parseConfiguration(response) {
	
		var arr = JSON.parse(response);
        // console.log(response); 
		var i, j;
		var out = "<table border=''><tr><td style='width: 300px;padding:7px; color:#000; background-color:#f1f1f1; text-align: center;'>Subsystem</td>";
		out += "<td style='width: 300px; color:#000;padding:7px;background-color:#f1f1f1; text-align: center;'>Version</td>";
		out += "<td style='width: 300px; color:#000;padding:7px;background-color:#f1f1f1; text-align: center;'>Build Date</td></tr>";
		//var arrLength = arr.array.length;


		//for (i = 0; i < arrLength; i++) {
			var thisConfiguration = arr;
			out += "<tr><td style='padding-left:10px;'>" + thisConfiguration.SsId
					+ "</td>";
			out +="<td>" + thisConfiguration.MfgDate
					+ "</td>";
            out += "<td style='padding-left:10px;'>" + thisConfiguration.LastModifiedDate
			+ "</td>";
			/*var numConditions = thisContract.Conditions.length;
			
			out += "<ul>";
			for (j = 0; j < numConditions; j++) {
				out += "<li>" + thisContract.Conditions[j] + "</li>";
			}
            */
			//out += "</td></tr>";
		//}
		out += "</table>";
		document.getElementById("configurationTable").innerHTML = out;
	}

	function parseHistory(response) {
		var arr = JSON.parse(response).array;
        console.log(response); 
		var i, j;
		var out = "<table border=''><tr><td style='width: 300px;padding:7px; color:#000; background-color:#f1f1f1; text-align: center;'>Subsystem</td>";
		out += "<td style='width: 300px; color:#000;padding:7px;background-color:#f1f1f1; text-align: center;'>Version</td>";
		out += "<td style='width: 300px; color:#000;padding:7px;background-color:#f1f1f1; text-align: center;'>Build Date</td></tr>";
		var arrLength = arr.length;


		for (i = 0; i < arrLength; i++) {
			var thisConfiguration = arr[i];
			out += "<tr><td style='padding-left:10px;'>" + thisConfiguration.SsId
					+ "</td>";
			out +="<td>" + thisConfiguration.MfgDate
					+ "</td>";
           out += "<td style='padding-left:10px;'>" + thisConfiguration.LastModifiedDate
			+ "</td>";
			/*var numConditions = thisContract.Conditions.length;
			
			out += "<ul>";
			for (j = 0; j < numConditions; j++) {
				out += "<li>" + thisContract.Conditions[j] + "</li>";
			}
           */
			//out += "</td></tr>";
		}
		out += "</table>";
		document.getElementById("historyTable").innerHTML = out;
	}
	
	// Parse a user account response from the Blockchain service into an HTML table
	function parseCompatibility(response) {
		console.log(response)
		var obj=JSON.parse(response).array;
		//will replace this with response
		//var obj={"Chassis":["023","024","025","031"],"Safety":["137","139","140"],"Telematics":["036","047","091"]}
        var ChassisString="";
		var SafetyString="";
		var TeleString="";
		obj["Chassis"].forEach(function(e){
			ChassisString=ChassisString+e+"</br>"
		});
		obj["Safety"].forEach(function(e){
			SafetyString=SafetyString+e+"</br>"
		});
		
		obj["Telematics"].forEach(function(e){
			TeleString=TeleString+e+"</br>"
		});
		
		var out = "<table border='1'><tr><td style='width: 80%; text-align: center; color: black; background-color:#f1f1f1;'>Subsystem</td>";
		out += "<td style='width: 80%; color: black; text-align: center; background-color:#f1f1f1;'>Compatibility Versions</td>";
		out += "</tr>"

		out += "<tr><td style='text-align:center;'>" + "Chassis"
				+ "</td><td style='text-align: center;'>" + ChassisString
				+ "</td></tr>"
				+"<tr><td style='text-align:center;'>" + "Safety"
				+ "</td><td style='text-align: center;'>" + SafetyString
				+ "</td></tr>"
				+"<tr><td style='text-align:center;'>" + "Telemetrics"
				+ "</td><td style='text-align: center;'>" + TeleString
				+ "</td></tr>";

		out += "</table>";
		document.getElementById("compatibilityTable").innerHTML = out;

	}

	// Get the smart contracts from the Blockchain service using the NODE JS REST API
	function displayConfiguration() {

		document.getElementById('ConfigurationPage').style.display = "block"
        var e = document.getElementById("SubSystem");
		
		var currentSubSystem = e.options[e.selectedIndex].value;
		var url 		= localUrlStub + "/getSubsystem?ssid=" + currentSubSystem;
		

		//var url = localUrlStub + "/getAllContracts";
		blockchainRestApi(url, parseConfiguration);
		//history Configuration
		//blockchainRestApi(url, parseHistory);
		var urlHistory = localUrlStub + "/getHistory?ssid=" + currentSubSystem;
		blockchainRestApi(url, parseHistory);
	}
	
	// Get the user transactions from the Blockchain service using the NODE JS REST API
	/*function displayUserTransactions() {
		var e = document.getElementById("userAccount");
		var strUser = e.options[e.selectedIndex].value;
		var url = localUrlStub + "/getusertransactions?userid=" + strUser;
		blockchainRestApi(url, parseTransactions);
	}*/
	// Issues a transfer points request to the Blockchain service using the NODE JS REST API
	/*function transferPoints() {
		transferString = "sender=" + fromUser + "&receiver=" + toUser
				+ "&amount=" + pointsAmount + "&description=" + description;

		var url = localUrlStub + "/transferpoints?" + transferString
				+ "&activities=2&type=Transfer&money=0"

		blockchainRestApi(url, parseTransfer);

	}*/
    function updateOTA(){
        /*var SubSystem = $("#SubSystemUpdate")[0];
        var version=$("#SubSystemVersion")[0];
		
		var currentSubSystem = SubSystem.options[SubSystem.selectedIndex].value;
		var currentVersion = version.options[SubSystem.selectedIndex].value;
		var url 		= localUrlStub + "/pushUpdate?ssid=" + currentSubSystem+"&version="+currentVersion;
		blockchainRestApi(url, updateResult); */
	}
	function updateResult(response){
		
		console.log(response)
	}
	function selectSubSystem(){
		//change the value in the dropdown list
	}
	// Get a user's account information from the Blockchain service using the NODE JS REST API
	function displayUpdate() {

		/*var e 			= document.getElementById("userAccount");
		var strUser 	= e.options[e.selectedIndex].value;
		var url 		= localUrlStub + "/getCustomerPoints?userid=" + strUser;*/

		//blockchainRestApi(url, updateConfiguration);
		//displayUserTransactions();
	}
	// Get a user's vehicle information from the blockchain service using the 
    // function changeVin() { 
   //		var e = document.getElementBy
    	      
	// Get a car's subsystem information from the Blockchain service using the NODE JS REST API
	function changeSubsystem() {

		var e = document.getElementById("SubSystem");
		
		var currentSubSystem = e.options[e.selectedIndex].value;
		var url 		= localUrlStub + "/getSubsystem?ssid=" + currentSubSystem;
		blockchainRestApi(url, parseConfiguration);

		var urlHistory = localUrlStub + "/getHistory?ssid=" + currentSubSystem;
		blockchainRestApi(url, parseHistory);

	}
   function changeVIN(){
	   
   }
   
	// Submit a new smart contract to the Blockchain service using the NODE JS REST API
	/*function addSmartContract() {

		var contractTerms = "contractid=" + contractId + "&title=" + title
				+ "&condition1=" + term1 + "&condition2=" + term2
				+ "&discountrate=" + discountRate;

		var url = localUrlStub + "/addSmartContract?" + contractTerms;
		blockchainRestApi(url, parseContract);

	}*/
	/*function parseTransfer(response) {

		document.getElementById('CompatibilityPage').style.display = "none"
		document.getElementById('CompatibilityMessage').style.display = "block"

	}*/

	// Parse a travel purchase response from Blockchain service
	/*function parseTravelPurchase(response) {

		document.getElementById('ConfigurationPage').style.display = "none"
		//document.getElementById('TravelOffersMessage').style.display = "block"
	}*/

	function updateSynchronize(response) {

		document.getElementById('SynchronizePage').style.display = "none"
		document.getElementById('SynchronizeMessage').style.display = "block"
	}
	// Parse an 'add contract' response from the Blockchain service
	/*function parseContract(response) {

		document.getElementById('CreateOfferPage').style.display = "none";
		//document.getElementById('CreateOfferMessage').style.display = "block";
	}*/

	// Refresh the 'Transfer Points' tab after a user submits a points transfer
	function displayCompatibility() {
		

		var url = localUrlStub + "/getCompatibility";
		blockchainRestApi(url, parseCompatibility);  
      
		document.getElementById('CompatibilityPage').style.display = "block";

	}
	
	function displaySynchronize() {
		document.getElementById('SynchronizePage').style.display = "block";
		document.getElementById('SynchronizeMessage').style.display = "none";
	}

	// Add event listeners to the tabs so they display the relevant content when clicked on
	$(document).ready(
			function() {
				$("#Configuration").click(displayConfiguration);
				//document.getElementById("Configuration").addEventListener(
					//	"click", displayConfiguration);
				document.getElementById("Update").addEventListener(
						"click", displayUpdate);
				document.getElementById("Compatibility").addEventListener(
						"click", displayCompatibility);
				document.getElementById("Synchronize").addEventListener(
						"click", displaySynchronize);
			});
	
	
	$(document).ready(function(){
	    $("#userAccount").on("change",function(){
	        var selectedVal=$( "#userAccount option:selected" ).val();
	        $("#subcategory > optgroup").attr("disabled","disabled");
	        $('#subcategory > optgroup[label="'+selectedVal+'"]').removeAttr("disabled");
	    });  
	});
	
</script>
</head>
<body>
	<div class="content">
		<div class="top-header">
			<div class="col50 main-font"> OEM OTA Update Management</div>
			<div class=" user">
				Subsystem: <select id="SubSystem" 
					onchange="changeSubsystem()">
					<option value="Telematics">Telematics</option>
					<option value="Powertrain">Powertrain</option>
					<option value="Chassis">Chassis</option>
					<option value="Safety">Safety</option>
				</select>
			</div>
			<div class="VIN">
			   VIN: <select id = "VIN" 
			   onchange= changeVIN()>
			   <option value="Value1">1FTYR44VX2PB60564</option>
			   <option value="Value2">KMHCN46CX9U370929</option>
			   <option value="Value3">JTDKTUD33DD559195</option>
			   <option value="Value4">4T1CE30P08U765674</option>
			   <option value ="Value5">4A4AR3AU6FE004670</option>
			   </select>
		    </div>
		  </div>

		<ul class="tab">
			<li><a href="#" class="tablinks"
				onclick="openTab(event, 'Configuration')">Configuration</a></li>
			<li><a href="#" class="tablinks"
				onclick="openTab(event, 'Update')">Update</a></li>
			<li><a href="#" class="tablinks"
				onclick="openTab(event, 'Compatibility')">Compatibility</a></li>
			<li id="FeedbackTab"><a href="#" class="tablinks"
				onclick="openTab(event, 'Synchronize')">Synchronize</a></li>			
		</ul>

		<div id="Configuration" class="tabcontent">
			<span id='ConfigurationPage'>

				<h3>Active Configuration</h3>
				<hr>
				<p id="configurationTable"></p>

				<h3 class="purchase-header">Configuration History</h3>
				<p id="historyTable"></p>
				<hr>
				<p></p>
				<p></p>				

			</span> 
		</div>

		<div id="Update" class="tabcontent">
			<h3>UpdateSystem</h3>
			<hr>


			<!--  <select id="SubSystemUpdate" onchange= selectSubSystem()>
					<option value="Telematics">Telematics</option>
					<option value="Powertrain">Powertrain</option>
					<option value="Chassis">Chassis</option>
					<option value="Safety">Safety</option>
				</select>
				<br>
			<select id="SubSystemVersion" >
					<option value="C023">023</option>
					<option value="C024">024</option>
					<option value="C025">025</option>
					<option value="C031">031</option>
			</select>
			<br> -->	

      <select name="userAccount" id="userAccount" onchange="changeSubsystem()">
                 <option value="Telematics" selected>Telematics</option>
   		        <option value="Powertrain">Powertrain</option>
           <option value="Chassis">Chassis</option>
           <option value="Safety">Safety</option>
         </select>
         
     <select name="subcategory" id="subcategory">

     <optgroup label="Telematics">
        <option value="340">340</option>
        <option value="350">350</option>
        <option value="360">360</option>
    </optgroup>
    <optgroup id="B" label="Powertrain" disabled>
        <option value="260">260</option>
        <option value="280">280</option>
        <option value="350">350</option>
    </optgroup>
    <optgroup id="C" label="Chassis" disabled>
        <option value="350">350</option>
        <option value="216">216</option>
        <option value="227">227</option>
    </optgroup>
    <optgroup id="D" label="Safety" disabled>
        <option value="315">315</option>
        <option value="206">206</option>
        <option value="207">207</option>
    </optgroup>
</select>							
		
		

			<button onclick="updateOTA()" class="purchase-btn">Submit</button>
			<span id='updateMessage' style='display: none'>
				Update completed! </span>
								
			
		</div>

		<div id="Compatibility" class="tabcontent">
        
			<span id='CompatibilityPage'>
			 <p id="compatibilityTable"></p>
			</span>
		
		</div>
		<div id="Synchronize" class="tabcontent">

			<span id='SynchronizePage'>
            <h3>Install Current Compatibility Master Segment</h3>
				
				<button onclick="submitSynchronize()" class="purchase-btn">Submit
				</button>
			</span> <span id='SynchronizeMessage'> Synchronize submitted! </span>
		</div>
	</div>
</body>
</html>
